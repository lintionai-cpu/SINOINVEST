<!DOCTYPE html>
<html lang="en" class="h-full">

  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SINOInvest — Client Dashboard</title>

    <link rel="icon" type="img/png" sizes="32x32" href="img/favicon-32x32.png">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            boxShadow: {
              soft: '0 10px 30px rgba(0,0,0,0.06)'
            }
          }
        }
      }

    </script>


    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Chart.js (for Pie/Bar/Line) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
   
    <style>
      /* Smooth section transitions */
      .page {
        display: none;
      }

      .page.active {
        display: block;
      }

    </style>

  </head>

  <body class="h-full bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100">
    <!-- Toast -->
    <div id="toast" class="fixed top-5 right-5 z-50 hidden"></div>

    <!-- App Shell -->
    <div class="min-h-screen grid grid-cols-1 lg:grid-cols-[260px,1fr]">
      <!-- Sidebar -->
      <aside
        class="bg-white dark:bg-gray-800 border-r border-gray-100 dark:border-gray-700 p-4 lg:sticky lg:top-0 lg:h-screen shadow-soft">
        <div class="flex items-center gap-3 mb-8">
          <div class="h-10 w-10 rounded-2xl grid place-items-center text-white font-bold">
            <img src="img/favicon.ico" alt="">
          </div>
          <div>
            <h1 class="text-lg font-semibold"><b>SINOInvest</b></h1>
            <p class="text-xs text-gray-500 dark:text-gray-400">Client Dashboard</p>
          </div>
        </div>

        <nav class="space-y-1" id="sideNav">
          <a data-route="#/dashboard"
            class="nav-link flex items-center gap-3 px-3 py-2 rounded-xl hover:bg-gray-100 hover:text-yellow-600 dark:hover:bg-gray-700 font-medium">
            <i data-lucide="layout-dashboard" class="w-4 h-4"></i><span>Dashboard</span>
          </a>
          <a data-route="#/portfolio"
            class="nav-link flex items-center gap-3 px-3 py-2 rounded-xl hover:bg-gray-100 hover:text-yellow-600 dark:hover:bg-gray-700 font-medium">
            <i data-lucide="pie-chart" class="w-4 h-4"></i><span>Portfolio</span>
          </a>
          <a data-route="#/transactions"
            class="nav-link flex items-center gap-3 px-3 py-2 rounded-xl hover:bg-gray-100 hover:text-yellow-600 dark:hover:bg-gray-700 font-medium">
            <i data-lucide="rows" class="w-4 h-4"></i><span>Transactions</span>
          </a>
          <a data-route="#/funds"
            class="nav-link flex items-center gap-3 px-3 py-2 rounded-xl hover:bg-gray-100 hover:text-yellow-600 dark:hover:bg-gray-700 font-medium">
            <i data-lucide="wallet" class="w-4 h-4"></i><span>Withdraw / Deposit</span>
          </a>
          <a data-route="#/messages"
            class="nav-link flex items-center gap-3 px-3 py-2 rounded-xl hover:bg-gray-100 hover:text-yellow-600 dark:hover:bg-gray-700 font-medium">
            <i data-lucide="message-square" class="w-4 h-4"></i><span>Messages</span>
          </a>
          <a data-route="#/settings"
            class="nav-link flex items-center gap-3 px-3 py-2 rounded-xl hover:bg-gray-100 hover:text-yellow-600 dark:hover:bg-gray-700 font-medium">
            <i data-lucide="settings" class="w-4 h-4"></i><span>Settings</span>
          </a>
          <a data-route="#/support"
            class="nav-link flex items-center gap-3 px-3 py-2 rounded-xl hover:bg-gray-100 hover:text-yellow-600 dark:hover:bg-gray-700 font-medium">
            <i data-lucide="life-buoy" class="w-4 h-4"></i><span>Support</span>
          </a>
        </nav>

        <div class="mt-8 space-y-2">
          <button id="btn-dark"
            class="w-full flex items-center justify-between px-3 py-2 rounded-xl bg-gray-100 hover:text-yellow-600 dark:bg-gray-700">
            <span class="flex items-center gap-2"><i data-lucide="moon" class="w-4 h-4"></i> Dark Mode</span>
            <span id="darkState" class="text-xs px-2 py-0.5 rounded bg-gray-200 dark:bg-gray-600">Auto</span>
          </button>
          <button id="btn-signout"
            class="w-full flex items-center gap-2 px-3 py-2 rounded-xl border border-gray-200 hover:text-yellow-600 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700">
            <i data-lucide="log-out" class="w-4 h-4"></i> Sign out
          </button>
        </div>
      </aside>

      <!-- Main -->
      <main class="p-4 sm:p-6 lg:p-8 space-y-6">
        <!-- Topbar -->
        <header class="flex items-center justify-between">
          <div>
            <h2 id="pageTitle" class="text-xl sm:text-2xl font-bold">Dashboard</h2>
            <p class="text-xs text-gray-500 dark:text-gray-400" id="userEmail"></p>
            
            
          </div>
          <div class="flex items-center gap-2">
            <div class="relative">
              <button id="btn-notify"
                class="p-2 rounded-xl border border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800">
                <i data-lucide="bell" class="w-5 h-5"></i>
              </button>
              <span id="badge"
                class="absolute -top-1 -right-1 text-[10px] bg-rose-500 text-white rounded-full px-1.5 py-0.5 hidden">0</span>
            </div>
            <img id="avatar" class="h-9 w-9 rounded-xl object-cover border border-gray-200 dark:border-gray-700"
              src="https://api.dicebear.com/7.x/initials/svg?seed=SI" alt="avatar" />
          </div>
        </header>

        <!-- PAGES -->
        <!-- 1. Dashboard -->
        <section id="page-dashboard" class="page active space-y-6">
          <!-- KPI Cards -->
          <div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-4">
            <div
              class="p-4 rounded-2xl bg-white dark:bg-gray-800 border border-gray-100 dark:border-gray-700 shadow-soft">
              <p class="text-sm text-gray-500 mb-1">Total Invested</p>
              <h3 id="kpi-invested" class="text-2xl font-bold">$0.00</h3>
            </div>
            <div class="p-4 rounded-2xl bg-white dark:bg-gray-800 border shadow-soft">
              <p class="text-sm text-gray-500 mb-1">Total Returns</p>
              <h3 id="kpi-returns" class="text-2xl font-bold text-yellow-600">$0.00</h3>
            </div>
            <div class="p-4 rounded-2xl bg-white dark:bg-gray-800 border shadow-soft">
              <p class="text-sm text-gray-500 mb-1">Available Balance</p>
              <h3 id="kpi-balance" class="text-2xl font-bold">$0.00</h3>
            </div>
            <div class="p-4 rounded-2xl bg-white dark:bg-gray-800 border shadow-soft">
              <p class="text-sm text-gray-500 mb-1"> ROI</p>
              <h3 id="kpi-roi7d" class="text-2xl font-bold">0.00%</h3>
            </div>
          </div>

          <!-- Charts Row -->
          <div class="grid grid-cols-1 xl:grid-cols-3 gap-4">
            <div class="xl:col-span-1 p-4 rounded-2xl bg-white dark:bg-gray-800 border shadow-soft">
              <div class="flex items-center justify-between mb-2">
                <h4 class="font-semibold">Asset Allocation</h4>
                <span class="text-xs text-gray-500">Pie</span>
              </div>
              <canvas id="chartAllocation" height="220"></canvas>
            </div>
            <div class="xl:col-span-2 p-4 rounded-2xl bg-white dark:bg-gray-800 border shadow-soft">
              <div class="flex items-center justify-between mb-2">
                <h4 class="font-semibold">ROI by Asset Class</h4>
                <span class="text-xs text-gray-500">Bar</span>
              </div>
              <canvas id="chartROI" height="220"></canvas>
            </div>
          </div>

          <!-- Recent Transactions -->
          <div class="p-4 rounded-2xl bg-white dark:bg-gray-800 border shadow-soft">
            <div class="flex items-center justify-between mb-3">
              <h4 class="font-semibold">Recent Transactions</h4>
              <a href="#/transactions" class="text-sm text-yellow-600 hover:underline">View all</a>
            </div>
            <div class="overflow-x-auto">
              <table class="min-w-full text-sm">
                <thead class="text-left text-gray-500">
                  <tr>
                    <th class="py-2">Date</th>
                    <th class="py-2">Type</th>
                    <th class="py-2">Asset</th>
                    <th class="py-2">Amount</th>
                    <th class="py-2">Status</th>
                  </tr>
                </thead>
                <tbody id="recentTxBody" class="divide-y divide-gray-100 dark:divide-gray-700"></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- 2. Portfolio -->
        <section id="page-portfolio" class="page space-y-6">
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
            <div class="p-4 rounded-2xl bg-white dark:bg-gray-800 border shadow-soft lg:col-span-1">
              <h4 class="font-semibold mb-2">By Asset Class</h4>
              <div class="space-y-3" id="classBreakdown"></div>
            </div>
            <div class="p-4 rounded-2xl bg-white dark:bg-gray-800 border shadow-soft lg:col-span-2">
              <div class="flex items-center justify-between mb-2">
                <h4 class="font-semibold">Portfolio Performance</h4>
                <select id="perfRange"
                  class="text-sm bg-transparent border border-gray-200 dark:border-gray-700 rounded-lg px-2 py-1">
                  <option value="7">7D</option>
                  <option value="30">30D</option>
                  <option value="90">90D</option>
                  <option value="365">1Y</option>
                </select>
              </div>
              <canvas id="chartPerf" height="240"></canvas>
            </div>
          </div>

          <!-- Individual Assets -->
          <div class="p-4 rounded-2xl bg-white dark:bg-gray-800 border shadow-soft">
            <div class="flex items-center justify-between mb-3">
              <h4 class="font-semibold">Holdings</h4>
              <div class="flex gap-2">
                <input id="assetSearch" placeholder="Search asset..."
                  class="text-sm rounded-lg border border-gray-200 dark:border-gray-700 bg-transparent px-3 py-1.5" />
                <select id="assetFilter"
                  class="text-sm rounded-lg border border-gray-200 dark:border-gray-700 bg-transparent px-2 py-1.5">
                  <option value="all">All</option>
                  <option value="stocks">Stocks</option>
                  <option value="crypto">Crypto</option>
                  <option value="real_estate">Real Estate</option>
                </select>
              </div>
            </div>
            <div class="overflow-x-auto">
              <table class="min-w-full text-sm">
                <thead class="text-left text-gray-500">
                  <tr>
                    <th class="py-2">Asset</th>
                    <th class="py-2">Class</th>
                    <th class="py-2">Units</th>
                    <th class="py-2">Avg. Cost</th>
                    <th class="py-2">Market Value</th>
                    <th class="py-2">P/L</th>
                  </tr>
                </thead>
                <tbody id="assetsBody" class="divide-y divide-gray-100 dark:divide-gray-700"></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- 3. Transactions -->
        <section id="page-transactions" class="page space-y-6">
          <div class="p-4 rounded-2xl bg-white dark:bg-gray-800 border shadow-soft">
            <div class="flex flex-wrap items-center gap-2 justify-between mb-3">
              <h4 class="font-semibold">Transaction History</h4>
              <div class="flex gap-2">
                <select id="txTypeFilter"
                  class="text-sm rounded-lg border border-gray-200 dark:border-gray-700 bg-transparent px-2 py-1.5">
                  <option value="all">All types</option>
                  <option value="deposit">Deposit</option>
                  <option value="withdrawal">Withdrawal</option>
                  <option value="transfer">Transfer</option>
                  <option value="dividend">Dividend</option>
                  <option value="trade">Trade</option>
                </select>
                <input type="date" id="txFrom"
                  class="text-sm rounded-lg border border-gray-200 dark:border-gray-700 bg-transparent px-2 py-1.5" />
                <input type="date" id="txTo"
                  class="text-sm rounded-lg border border-gray-200 dark:border-gray-700 bg-transparent px-2 py-1.5" />
              </div>
            </div>
            <div class="overflow-x-auto">
              <table class="min-w-full text-sm">
                <thead class="text-left text-gray-500">
                  <tr>
                    <th class="py-2">Date</th>
                    <th class="py-2">Type</th>
                    <th class="py-2">Reference</th>
                    <th class="py-2">Amount</th>
                    <th class="py-2">Method</th>
                    <th class="py-2">Status</th>
                  </tr>
                </thead>
                <tbody id="txBody" class="divide-y divide-gray-100 dark:divide-gray-700"></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- 4. Funds (Withdraw / Deposit) -->
        <section id="page-funds" class="page space-y-6">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- Deposit -->
            <div class="p-4 rounded-2xl bg-white dark:bg-gray-800 border shadow-soft">
              <h4 class="font-semibold mb-3">Deposit Funds</h4>
              <form id="form-deposit" class="space-y-3">
                <input name="amount" type="number" min="500" step="0.01" placeholder="Amount (USD)"
                  class="w-full rounded-xl border border-gray-200 dark:border-gray-700 bg-transparent px-3 py-2"
                  required />
                <select name="method"
                  class="w-full rounded-xl border border-gray-200 dark:border-gray-700 bg-transparent px-3 py-2"
                  required>
                  <option value="bank">Bank Transfer</option>
                  <option value="card">Debit/Credit Card</option>
                  <option value="crypto">Crypto (USDT/TRC20)</option>
                </select>
                <button class="w-full rounded-xl bg-yellow-600 hover:bg-gray-900 text-white px-4 py-2">Deposit</button>
              </form>
              <div class="mt-3 text-xs text-gray-500">Linked methods:</div>
              <div id="linkedMethods" class="mt-1 text-sm"></div>
              <button id="btn-link" class="mt-3 text-sm text-yellow-600 hover:underline">Link bank / wallet</button>
            </div>

            <!-- Withdraw -->
            <div class="p-4 rounded-2xl bg-white dark:bg-gray-800 border shadow-soft">
              <h4 class="font-semibold mb-3">Withdraw Funds</h4>
              <form id="form-withdraw" class="space-y-3">
                <input name="amount" type="number" min="500" step="0.01" placeholder="Amount (USD)"
                  class="w-full rounded-xl border border-gray-200 dark:border-gray-700 bg-transparent px-3 py-2"
                  required />
                <select name="method"
                  class="w-full rounded-xl border border-gray-200 dark:border-gray-700 bg-transparent px-3 py-2"
                  required>
                  <option value="bank">Bank Transfer</option>
                  <option value="crypto">Crypto (USDT/TRC20)</option>
                </select>
                <button
                  class="w-full rounded-xl bg-gray-900 dark:bg-gray-700 hover:opacity-90 text-white px-4 py-2">Withdraw</button>
              </form>
              <p class="text-xs text-gray-500 mt-2">Withdrawals T+1; compliance checks may apply.</p>
            </div>
          </div>
        </section>

        <!-- 5. Messages / Notifications -->
        <section id="page-messages" class="page space-y-6">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <!-- Threads -->
            <div class="p-4 rounded-2xl bg-white dark:bg-gray-800 border shadow-soft md:col-span-1">
              <div class="flex items-center justify-between mb-2">
                <h4 class="font-semibold">Conversations</h4>
                <button id="btn-new-thread" class="text-sm text-yellow-600 hover:underline">New</button>
              </div>
              <div id="threads" class="space-y-2 max-h-[420px] overflow-y-auto"></div>
            </div>
            <!-- Chat -->
            <div class="p-4 rounded-2xl bg-white dark:bg-gray-800 border shadow-soft md:col-span-2">
              <div id="chatWindow" class="h-[360px] overflow-y-auto space-y-3 mb-3"></div>
              <form id="form-message" class="flex gap-2">
                <input id="msgText" placeholder="Type a message..."
                  class="flex-1 rounded-xl border border-gray-200 dark:border-gray-700 bg-transparent px-3 py-2" />
                <button class="rounded-xl bg-yellow-600 hover:bg-gray-700 text-white px-4">Send</button>
              </form>
            </div>
          </div>

          <!-- System Alerts -->
          <div class="p-4 rounded-2xl bg-white dark:bg-gray-800 border shadow-soft">
            <div class="flex items-center justify-between mb-3">
              <h4 class="font-semibold">System Alerts</h4>
              <button id="btn-clear-alerts" class="text-sm text-rose-600 hover:underline">Clear all</button>
            </div>
            <div id="alerts" class="space-y-2"></div>
          </div>
        </section>

        <!-- 6. Settings / Profile -->
        <section id="page-settings" class="page space-y-6">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- Profile -->
            <div class="p-4 rounded-2xl bg-white dark:bg-gray-800 border shadow-soft">
              <h4 class="font-semibold mb-3">Profile</h4>
              <form id="form-profile" class="space-y-3">
                <input name="fullName" placeholder="Full name"
                  class="w-full rounded-xl border border-gray-200 dark:border-gray-700 bg-transparent px-3 py-2" />
                <input name="phone" placeholder="Phone"
                  class="w-full rounded-xl border border-gray-200 dark:border-gray-700 bg-transparent px-3 py-2" />
                <input name="country" placeholder="Country"
                  class="w-full rounded-xl border border-gray-200 dark:border-gray-700 bg-transparent px-3 py-2" />
                <button
                  class="rounded-xl bg-gray-900 dark:bg-gray-700 hover:opacity-90 text-white px-4 py-2">Save</button>
              </form>
            </div>
            <!-- Security -->
            <div class="p-4 rounded-2xl bg-white dark:bg-gray-800 border shadow-soft">
              <h4 class="font-semibold mb-3">Security</h4>
              <form id="form-password" class="space-y-3">
                <input name="current" type="password" placeholder="Current password"
                  class="w-full rounded-xl border border-gray-200 dark:border-gray-700 bg-transparent px-3 py-2" />
                <input name="new" type="password" placeholder="New password"
                  class="w-full rounded-xl border border-gray-200 dark:border-gray-700 bg-transparent px-3 py-2" />
                <button class="rounded-xl bg-gray-900 dark:bg-gray-700 hover:opacity-90 text-white px-4 py-2">Update
                  Password</button>
              </form>
              <div class="mt-4">
                <h5 class="font-medium mb-2">Two-Factor Authentication (2FA)</h5>
                <button id="btn-enable-2fa"
                  class="rounded-xl border border-gray-200 dark:border-gray-700 px-3 py-2 hover:bg-gray-50 dark:hover:bg-gray-700 text-sm">Enable
                  SMS 2FA</button>
                <p class="text-xs text-gray-500 mt-2">Uses Firebase Multi-Factor Auth. SMS fees may apply.</p>
              </div>
            </div>
          </div>

          <!-- Preferences -->
          <div class="p-4 rounded-2xl bg-white dark:bg-gray-800 border shadow-soft">
            <h4 class="font-semibold mb-3">Preferences</h4>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div>
                <label class="text-sm">Language</label>
                <select id="pref-language"
                  class="w-full mt-1 rounded-xl border border-gray-200 dark:border-gray-700 bg-transparent px-3 py-2">
                  <option value="en">English</option>
                  <option value="zh">中文</option>
                  <option value="de">Deutsch</option>
                </select>
              </div>
              <div>
                <label class="text-sm">Theme</label>
                <select id="pref-theme"
                  class="w-full mt-1 rounded-xl border border-gray-200 dark:border-gray-700 bg-transparent px-3 py-2">
                  <option value="system">System</option>
                  <option value="light">Light</option>
                  <option value="dark">Dark</option>
                </select>
              </div>
              <div>
                <label class="text-sm">Currency</label>
                <select id="pref-currency"
                  class="w-full mt-1 rounded-xl border border-gray-200 dark:border-gray-700 bg-transparent px-3 py-2">
                  <option value="USD">USD</option>
                  <option value="EUR">EUR</option>
                  <option value="CNY">CNY</option>
                </select>
              </div>
            </div>
          </div>
        </section>

        <!-- 7. Support / Help Center -->
        <section id="page-support" class="page space-y-6">
          <div class="p-4 rounded-2xl bg-white dark:bg-gray-800 border shadow-soft">
            <h4 class="font-semibold mb-3">FAQs</h4>
            <div class="divide-y divide-gray-200 dark:divide-gray-700" id="faqs">
              <!-- FAQ items populated at runtime -->
            </div>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="p-4 rounded-2xl bg-white dark:bg-gray-800 border shadow-soft">
              <h4 class="font-semibold mb-3">Open a Ticket</h4>
              <form id="form-ticket" class="space-y-3">
                <input name="subject" placeholder="Subject"
                  class="w-full rounded-xl border border-gray-200 dark:border-gray-700 bg-transparent px-3 py-2" />
                <textarea name="message" placeholder="Describe your issue"
                  class="w-full rounded-xl border border-gray-200 dark:border-gray-700 bg-transparent px-3 py-2 h-28"></textarea>
                <button class="rounded-xl bg-yellow-600 hover:bg-black text-white px-4 py-2">Submit</button>
              </form>
            </div>
            <div class="p-4 rounded-2xl bg-white dark:bg-gray-800 border shadow-soft">
              <h4 class="font-semibold mb-3">Contact</h4>
              <div class="space-y-1 text-sm">
                <p>Email: <a class="text-yellow-600"
                    href="mailto:sinovest@gmail.com?subject=Support%20Request">info@sinoinvestfinance.com</a></p>
                <p>WhatsApp: <a class="text-yellow-600" href="https://wa.me/49308321445" target="_blank">(+49) 30 8321 4455
                    </a></p>
                <p>Telegram: <a class="text-yellow-600" href="https://t.me/sinoinvest" target="_blank">@sinoinvest</a>
                </p>
              </div>
            </div>
          </div>
        </section>

      </main>
    </div>

    <!-- Link Method Modal -->
    <div id="modal" class="fixed inset-0 bg-black/40 hidden items-center justify-center p-4 z-50">
      <div
        class="w-full max-w-lg rounded-2xl bg-white dark:bg-gray-800 border border-gray-100 dark:border-gray-700 p-4">
        <div class="flex items-center justify-between mb-3">
          <h4 class="font-semibold">Link Method</h4>
          <button id="modal-close" class="p-1 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700"><i data-lucide="x"
              class="w-4 h-4"></i></button>
        </div>
        <form id="form-link" class="space-y-3">
          <select name="type"
            class="w-full rounded-xl border border-gray-200 dark:border-gray-700 bg-transparent px-3 py-2" required>
            <option value="bank">Bank Account</option>
            <option value="wallet">Crypto Wallet (USDT TRC20)</option>
          </select>
          <input name="label" placeholder="Label (e.g., Swiss Bank, TRC20 Wallet)"
            class="w-full rounded-xl border border-gray-200 dark:border-gray-700 bg-transparent px-3 py-2" required />
          <input name="details" placeholder="IBAN/Acct No or Wallet Address"
            class="w-full rounded-xl border border-gray-200 dark:border-gray-700 bg-transparent px-3 py-2" required />
          <div class="flex justify-end gap-2">
            <button type="button" id="modal-cancel"
              class="rounded-xl border border-gray-200 dark:border-gray-700 px-3 py-2">Cancel</button>
            <button class="rounded-xl bg-yellow-600 hover:bg-black text-white px-4 py-2">Save</button>
          </div>
        </form>
      </div>
    </div>
    


<!-- Supabase JS SDK -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
/**
 * SINOInvest — Supabase Dashboard Controller
 * Controls: auth-gate, routing, data fetch, updates, charts, forms, toasts, dark mode
 * Requires: Tailwind (already on page), Chart.js (already on page), Lucide (already on page)
 * File target: dashboard.html
 */

;(() => {
  // ==== 0) CONFIG =====
  const SUPABASE_URL = 'https://nqfziiabvgjxolfklein.supabase.co';        // <-- replace
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5xZnppaWFidmdqeG9sZmtsZWluIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU3MzI2MDYsImV4cCI6MjA3MTMwODYwNn0.LmupQPyQzC2QZ-kIkNdr0_XO76zyJqLSygA1Tc03R4s';             // <-- replace
  const LOGIN_PAGE = 'login.html'; // If session missing, redirect here

  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

  // Basic DOM utils
  const $  = (id) => document.getElementById(id)
  const $$ = (sel, root = document) => Array.from(root.querySelectorAll(sel))

  // ==== 1) TOAST (Tailwind, no deps) ====
  function toast(message, type = 'info') {
    const host = $('toast')
    if (!host) return alert(message)
    host.className = 'fixed top-5 right-5 z-50'
    const el = document.createElement('div')
    const colors = {
      info:   'bg-gray-900 text-white',
      success:'bg-green-600 text-white',
      error:  'bg-rose-600 text-white',
      warn:   'bg-amber-500 text-white',
    }
    el.className = `mb-2 rounded-xl px-4 py-2 shadow-lg ${colors[type] || colors.info}`
    el.textContent = message
    host.appendChild(el)
    setTimeout(() => el.remove(), 3500)
  }

  // ==== 2) AUTH-GATE ====
  let currentUser = null

  async function ensureSession() {
    const { data, error } = await supabase.auth.getSession()
    if (error) {
      toast(error.message, 'error')
      location.href = LOGIN_PAGE
      return null
    }
    if (!data.session) {
      location.href = LOGIN_PAGE
      return null
    }
    return data.session.user
  }

  // ==== 3) ROUTER (hash-based) ====
  const routes = {
    '#/dashboard': 'page-dashboard',
    '#/portfolio': 'page-portfolio',
    '#/transactions': 'page-transactions',
    '#/funds': 'page-funds',
    '#/messages': 'page-messages',
    '#/settings': 'page-settings',
    '#/support': 'page-support',
  }

  function setActiveRoute(hash) {
    const target = routes[hash] || routes['#/dashboard']
    $$('#pageTitle').forEach(el => el.textContent = (hash?.slice(2) || 'dashboard').replace('-', ' ').replace(/\b\w/g, c => c.toUpperCase()))
    $$('.page').forEach(sec => sec.classList.remove('active'))
    $(target).classList.add('active')
    // Highlight active in sidebar
    $$('#sideNav .nav-link').forEach(a => {
      if (a.getAttribute('data-route') === hash) {
        a.classList.add('bg-gray-100', 'dark:bg-gray-700', 'text-yellow-600')
      } else {
        a.classList.remove('bg-gray-100', 'dark:bg-gray-700', 'text-yellow-600')
      }
    })
  }

  function initRouter() {
    // Default to dashboard
    if (!location.hash || !routes[location.hash]) location.hash = '#/dashboard'
    setActiveRoute(location.hash)
    window.addEventListener('hashchange', () => setActiveRoute(location.hash))
    // Sidebar clicks
    $$('#sideNav .nav-link').forEach(a => {
      a.addEventListener('click', () => {
        const r = a.getAttribute('data-route')
        if (r && routes[r]) location.hash = r
      })
    })
  }

  // ==== 4) DARK MODE ====
  function applyDark(pref = localStorage.getItem('theme') || 'system') {
    const root = document.documentElement
    const dark = pref === 'dark' || (pref === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches)
    root.classList.toggle('dark', !!dark)
    $('darkState') && ($('darkState').textContent = pref === 'system' ? 'Auto' : (dark ? 'Dark' : 'Light'))
  }

  function initDark() {
    applyDark()
    $('btn-dark')?.addEventListener('click', () => {
      const curr = localStorage.getItem('theme') || 'system'
      const next = curr === 'system' ? 'dark' : (curr === 'dark' ? 'light' : 'system')
      localStorage.setItem('theme', next)
      applyDark(next)
    })
  }

  // ==== 5) DATA LAYER (Supabase tables) ====
  /**
   * Expected tables (recommended schema):
   * - profiles: { id uuid (PK == auth.uid), email text, full_name text, phone text, country text, avatar_url text, currency text, language text, theme text }
   * - portfolio: { user_id uuid (PK), allocation jsonb, roi jsonb, perf jsonb }
   * - holdings: { id uuid PK, user_id uuid, asset text, class text, units numeric, avg_cost numeric, market_value numeric, pl numeric }
   * - transactions: { id uuid PK, user_id uuid, ts timestamptz, type text, reference text, amount numeric, method text, status text }
   * - methods: { id uuid PK, user_id uuid, type text, label text, details text }
   * - alerts: { id uuid PK, user_id uuid, message text, level text, ts timestamptz }
   * - threads: { id uuid PK, user_id uuid, subject text, last_ts timestamptz }
   * - messages: { id uuid PK, thread_id uuid, user_id uuid, ts timestamptz, text text, from_admin boolean }
   */

  // Helpers
  const q = {
    // Select helpers
    async profile(user_id) {
      return supabase.from('profiles').select('*').eq('id', user_id).maybeSingle()
    },
    async upsertProfile(payload) {
      // Upsert preferred; uses update syntax when row exists
      return supabase.from('profiles').upsert(payload).select().single()
    },
    async updateProfile(user_id, patch) {
      // <-- explicit UPDATE syntax requested
      return supabase.from('profiles').update(patch).eq('id', user_id).select().single()
    },
    async setPassword(newPassword) {
      return supabase.auth.updateUser({ password: newPassword })
    },
    async portfolio(user_id) {
      return supabase.from('portfolio').select('*').eq('user_id', user_id).maybeSingle()
    },
    async updatePortfolio(user_id, patch) {
      return supabase.from('portfolio').update(patch).eq('user_id', user_id)
    },
    async holdings(user_id, filter = {}) {
      let req = supabase.from('holdings').select('*').eq('user_id', user_id)
      if (filter.class && filter.class !== 'all') req = req.eq('class', filter.class)
      if (filter.search) req = req.ilike('asset', `%${filter.search}%`)
      return req.order('asset', { ascending: true })
    },
    async transactions(user_id, opts = {}) {
      let req = supabase.from('transactions').select('*').eq('user_id', user_id)
      if (opts.type && opts.type !== 'all') req = req.eq('type', opts.type)
      if (opts.from) req = req.gte('ts', opts.from)
      if (opts.to) req = req.lte('ts', opts.to)
      return req.order('ts', { ascending: false }).limit(100)
    },
    async addTransaction(payload) {
      return supabase.from('transactions').insert(payload).select().single()
    },
    async methods(user_id) {
      return supabase.from('methods').select('*').eq('user_id', user_id).order('label', { ascending: true })
    },
    async addMethod(payload) {
      return supabase.from('methods').insert(payload).select().single()
    },
    async alerts(user_id) {
      return supabase.from('alerts').select('*').eq('user_id', user_id).order('ts', { ascending: false }).limit(50)
    },
    async clearAlerts(user_id) {
      return supabase.from('alerts').delete().eq('user_id', user_id)
    },
    async threads(user_id) {
      return supabase.from('threads').select('*').eq('user_id', user_id).order('last_ts', { ascending: false })
    },
    async addThread(payload) {
      return supabase.from('threads').insert(payload).select().single()
    },
    async messages(thread_id) {
      return supabase.from('messages').select('*').eq('thread_id', thread_id).order('ts', { ascending: true })
    },
    async addMessage(payload) {
      return supabase.from('messages').insert(payload).select().single()
    }
  }

  // ==== 6) STATE + RENDERERS ====
  const state = {
    portfolio: null,
    holdings: [],
    transactions: [],
    methods: [],
    alerts: [],
    threads: [],
    activeThreadId: null,
    charts: {
      alloc: null,
      roi: null,
      perf: null
    }
  }

  function fmtMoney(v) {
    const n = Number(v || 0)
    return n.toLocaleString(undefined, { style: 'currency', currency: 'USD' })
  }

  function fmtPct(v) {
    const n = Number(v || 0)
    return `${n.toFixed(2)}%`
  }

  function renderKPIs() {
    // Simple derivations from holdings & transactions
    const invested = state.holdings.reduce((a, h) => a + Number(h.units) * Number(h.avg_cost), 0)
    const mv = state.holdings.reduce((a, h) => a + Number(h.market_value), 0)
    const returns = mv - invested
    const balance = Math.max(0, state.transactions
      .filter(t => t.status !== 'failed')
      .reduce((a, t) => a + (t.type === 'deposit' ? Number(t.amount) : t.type === 'withdrawal' ? -Number(t.amount) : 0), 0))
    const roi = invested > 0 ? (returns / invested) * 100 : 0

    $('kpi-invested').textContent = fmtMoney(invested)
    $('kpi-returns').textContent = fmtMoney(returns)
    $('kpi-balance').textContent = fmtMoney(balance)
    $('kpi-roi7d').textContent = fmtPct(roi)
  }

  function renderRecentTransactions() {
    const tbody = $('recentTxBody')
    tbody.innerHTML = ''
    state.transactions.slice(0, 6).forEach(t => {
      const tr = document.createElement('tr')
      tr.innerHTML = `
        <td class="py-2">${new Date(t.ts).toLocaleString()}</td>
        <td class="py-2 capitalize">${t.type}</td>
        <td class="py-2">${t.reference || '-'}</td>
        <td class="py-2">${fmtMoney(t.amount)}</td>
        <td class="py-2">
          <span class="px-2 py-0.5 rounded text-xs ${t.status === 'completed' ? 'bg-green-100 text-green-700' : t.status === 'pending' ? 'bg-amber-100 text-amber-700' : 'bg-rose-100 text-rose-700'}">${t.status}</span>
        </td>`
      tbody.appendChild(tr)
    })
  }

  function renderTransactionsTable(list = state.transactions) {
    const tbody = $('txBody')
    tbody.innerHTML = ''
    list.forEach(t => {
      const tr = document.createElement('tr')
      tr.innerHTML = `
        <td class="py-2">${new Date(t.ts).toLocaleDateString()}</td>
        <td class="py-2 capitalize">${t.type}</td>
        <td class="py-2">${t.reference || '-'}</td>
        <td class="py-2">${fmtMoney(t.amount)}</td>
        <td class="py-2">${t.method || '-'}</td>
        <td class="py-2">${t.status}</td>`
      tbody.appendChild(tr)
    })
  }

  function renderHoldings() {
    const tbody = $('assetsBody')
    tbody.innerHTML = ''
    state.holdings.forEach(h => {
      const tr = document.createElement('tr')
      tr.innerHTML = `
        <td class="py-2">${h.asset}</td>
        <td class="py-2 capitalize">${h.class}</td>
        <td class="py-2">${h.units}</td>
        <td class="py-2">${fmtMoney(h.avg_cost)}</td>
        <td class="py-2">${fmtMoney(h.market_value)}</td>
        <td class="py-2 ${h.pl >= 0 ? 'text-green-600' : 'text-rose-600'}">${fmtMoney(h.pl)}</td>`
      tbody.appendChild(tr)
    })
  }

  function renderMethods() {
    const box = $('linkedMethods')
    box.innerHTML = state.methods.length
      ? state.methods.map(m => `<div class="text-gray-700 dark:text-gray-300">${m.type} — <b>${m.label}</b> <span class="text-xs text-gray-500">${m.details}</span></div>`).join('')
      : '<div class="text-gray-500 text-sm">No methods linked yet.</div>'
  }

  function renderAlerts() {
    const box = $('alerts')
    box.innerHTML = state.alerts.map(a => `
      <div class="p-3 rounded-xl border border-gray-200 dark:border-gray-700 ${a.level === 'high' ? 'bg-rose-50 dark:bg-rose-950/20' : 'bg-gray-50 dark:bg-gray-800'}">
        <div class="text-sm">${a.message}</div>
        <div class="text-xs text-gray-500 mt-1">${new Date(a.ts).toLocaleString()}</div>
      </div>`).join('')
  }

  function renderThreads() {
    const box = $('threads')
    box.innerHTML = ''
    state.threads.forEach(t => {
      const el = document.createElement('button')
      el.className = `w-full text-left p-2 rounded-lg border border-gray-200 dark:border-gray-700 ${state.activeThreadId === t.id ? 'bg-gray-100 dark:bg-gray-700' : ''}`
      el.innerHTML = `<div class="font-medium">${t.subject}</div><div class="text-xs text-gray-500">${new Date(t.last_ts).toLocaleString()}</div>`
      el.addEventListener('click', async () => {
        state.activeThreadId = t.id
        renderThreads()
        await loadMessages(t.id)
      })
      box.appendChild(el)
    })
  }

  async function loadMessages(thread_id) {
    const { data, error } = await q.messages(thread_id)
    if (error) return toast(error.message, 'error')
    const chat = $('chatWindow')
    chat.innerHTML = ''
    data.forEach(m => {
      const row = document.createElement('div')
      row.className = `max-w-[80%] px-3 py-2 rounded-xl ${m.from_admin ? 'bg-gray-200 dark:bg-gray-700 self-start' : 'bg-yellow-600 text-white self-end ml-auto'}`
      row.innerHTML = `<div class="text-sm">${m.text}</div><div class="text-[10px] opacity-70 mt-1">${new Date(m.ts).toLocaleTimeString()}</div>`
      chat.appendChild(row)
    })
    chat.scrollTop = chat.scrollHeight
  }

  // ==== 7) CHARTS (Chart.js) ====
  function initOrUpdatePie(ctxId, labels, values) {
    const ctx = document.getElementById(ctxId)
    const cfg = {
      type: 'pie',
      data: { labels, datasets: [{ data: values }] },
      options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
    }
    if (state.charts.alloc) { state.charts.alloc.data.labels = labels; state.charts.alloc.data.datasets[0].data = values; state.charts.alloc.update(); }
    else state.charts.alloc = new Chart(ctx, cfg)
  }

  function initOrUpdateBar(ctxId, labels, values, label='ROI') {
    const ctx = document.getElementById(ctxId)
    const cfg = {
      type: 'bar',
      data: { labels, datasets: [{ label, data: values }] },
      options: { responsive: true, plugins: { legend: { display: false } } }
    }
    if (state.charts.roi) { state.charts.roi.data.labels = labels; state.charts.roi.data.datasets[0].data = values; state.charts.roi.update(); }
    else state.charts.roi = new Chart(ctx, cfg)
  }

  function initOrUpdateLine(ctxId, labels, values, label='Perf') {
    const ctx = document.getElementById(ctxId)
    const cfg = {
      type: 'line',
      data: { labels, datasets: [{ label, data: values, tension: 0.35, fill: false }] },
      options: { responsive: true, plugins: { legend: { display: false } } }
    }
    if (state.charts.perf) { state.charts.perf.data.labels = labels; state.charts.perf.data.datasets[0].data = values; state.charts.perf.update(); }
    else state.charts.perf = new Chart(ctx, cfg)
  }

  function renderPortfolioCharts() {
    const alloc = (state.portfolio?.allocation || []).map(x => ({ label: x.label, value: Number(x.value) }))
    const roi   = (state.portfolio?.roi || []).map(x => ({ label: x.label, value: Number(x.value) }))
    const perf  = (state.portfolio?.perf || { labels: [], values: [] })

    initOrUpdatePie('chartAllocation', alloc.map(x=>x.label), alloc.map(x=>x.value))
    initOrUpdateBar('chartROI', roi.map(x=>x.label), roi.map(x=>x.value), 'ROI %')
    initOrUpdateLine('chartPerf', perf.labels || [], (perf.values || []).map(Number), 'Performance')
  }

  function renderClassBreakdown() {
    const box = $('classBreakdown')
    const alloc = (state.portfolio?.allocation || [])
    if (!alloc.length) { box.innerHTML = '<div class="text-sm text-gray-500">No data</div>'; return }
    box.innerHTML = alloc.map(a => `
      <div class="flex items-center justify-between rounded-xl border border-gray-200 dark:border-gray-700 px-3 py-2">
        <span>${a.label}</span>
        <span class="font-semibold">${a.value}%</span>
      </div>`).join('')
  }

  // ==== 8) LOAD DATA ====
  async function bootstrap() {
    // Profile
    const { data: prof, error: perr } = await q.profile(currentUser.id)
    if (perr) toast(perr.message, 'error')
    $('userEmail').textContent = currentUser.email || '—'
    $('avatar').src = prof?.avatar_url || `https://api.dicebear.com/7.x/initials/svg?seed=${encodeURIComponent(currentUser.email || 'SI')}`

    // Portfolio
    const { data: pf, error: pferr } = await q.portfolio(currentUser.id)
    if (pferr) toast(pferr.message, 'error')
    state.portfolio = pf || {
      user_id: currentUser.id,
      allocation: [{ label: 'Crypto', value: 40 }, { label: 'Real Estate', value: 35 }, { label: 'Stocks', value: 25 }],
      roi: [{ label: 'Crypto', value: 18 }, { label: 'Real Estate', value: 9 }, { label: 'Stocks', value: 12 }],
      perf: { labels: ['D1','D2','D3','D4','D5','D6','D7'], values: [100,101,103,102,104,105,106] }
    }

    // Holdings
    const { data: holds, error: herr } = await q.holdings(currentUser.id)
    if (herr) toast(herr.message, 'error')
    state.holdings = holds || []

    // Transactions
    const { data: tx, error: terr } = await q.transactions(currentUser.id)
    if (terr) toast(terr.message, 'error')
    state.transactions = tx || []

    // Methods
    const { data: meth, error: merr } = await q.methods(currentUser.id)
    if (merr) toast(merr.message, 'error')
    state.methods = meth || []

    // Alerts
    const { data: al, error: aerr } = await q.alerts(currentUser.id)
    if (aerr) toast(aerr.message, 'error')
    state.alerts = al || []

    // Threads
    const { data: th, error: therr } = await q.threads(currentUser.id)
    if (therr) toast(therr.message, 'error')
    state.threads = th || []
    state.activeThreadId = state.threads[0]?.id || null

    // Render
    renderMethods()
    renderAlerts()
    renderThreads()
    renderHoldings()
    renderKPIs()
    renderRecentTransactions()
    renderTransactionsTable()
    renderPortfolioCharts()
    renderClassBreakdown()
    if (state.activeThreadId) await loadMessages(state.activeThreadId)
  }

  // ==== 9) EVENTS / FORMS (CRUD with UPDATE syntax where relevant) ====
  function initEvents() {
    // Sign out
    $('btn-signout')?.addEventListener('click', async () => {
      await supabase.auth.signOut()
      toast('Signed out', 'success')
      location.href = LOGIN_PAGE
    })

    // Deposit
    $('form-deposit')?.addEventListener('submit', async (e) => {
      e.preventDefault()
      const fd = new FormData(e.currentTarget)
      const amount = Number(fd.get('amount'))
      const method = String(fd.get('method'))
      if (isNaN(amount) || amount <= 0) return toast('Enter a valid amount', 'warn')

      const payload = { user_id: currentUser.id, ts: new Date().toISOString(), type: 'deposit', reference: crypto.randomUUID(), amount, method, status: 'pending' }
      const { data, error } = await q.addTransaction(payload)
      if (error) return toast(error.message, 'error')
      state.transactions.unshift(data)
      renderRecentTransactions(); renderTransactionsTable(); renderKPIs()
      toast('Deposit request submitted', 'success')
      e.currentTarget.reset()
    })

    // Withdraw
    $('form-withdraw')?.addEventListener('submit', async (e) => {
      e.preventDefault()
      const fd = new FormData(e.currentTarget)
      const amount = Number(fd.get('amount'))
      const method = String(fd.get('method'))
      if (isNaN(amount) || amount <= 0) return toast('Enter a valid amount', 'warn')

      const payload = { user_id: currentUser.id, ts: new Date().toISOString(), type: 'withdrawal', reference: crypto.randomUUID(), amount, method, status: 'pending' }
      const { data, error } = await q.addTransaction(payload)
      if (error) return toast(error.message, 'error')
      state.transactions.unshift(data)
      renderRecentTransactions(); renderTransactionsTable(); renderKPIs()
      toast('Withdrawal request submitted', 'success')
      e.currentTarget.reset()
    })

    // Link method (modal)
    const modal = $('modal')
    $('btn-link')?.addEventListener('click', () => { modal.classList.remove('hidden'); modal.classList.add('flex') })
    $('modal-close')?.addEventListener('click', () => { modal.classList.add('hidden'); modal.classList.remove('flex') })
    $('modal-cancel')?.addEventListener('click', () => { modal.classList.add('hidden'); modal.classList.remove('flex') })
    $('form-link')?.addEventListener('submit', async (e) => {
      e.preventDefault()
      const fd = new FormData(e.currentTarget)
      const payload = {
        user_id: currentUser.id,
        type: String(fd.get('type')),
        label: String(fd.get('label')),
        details: String(fd.get('details'))
      }
      const { data, error } = await q.addMethod(payload)
      if (error) return toast(error.message, 'error')
      state.methods.push(data)
      renderMethods()
      toast('Method linked', 'success')
      modal.classList.add('hidden'); modal.classList.remove('flex')
      e.currentTarget.reset()
    })

    // Profile Save (uses explicit UPDATE syntax)
    $('form-profile')?.addEventListener('submit', async (e) => {
      e.preventDefault()
      const fd = new FormData(e.currentTarget)
      const patch = {
        full_name: String(fd.get('fullName') || '').trim(),
        phone: String(fd.get('phone') || '').trim(),
        country: String(fd.get('country') || '').trim()
      }
      // UPDATE profiles ... WHERE id = currentUser.id
      const { data, error } = await q.updateProfile(currentUser.id, patch)
      if (error) return toast(error.message, 'error')
      toast('Profile updated', 'success')
      // Refresh cached
      await bootstrap()
    })

    // Password Update (Supabase auth)
    $('form-password')?.addEventListener('submit', async (e) => {
      e.preventDefault()
      const fd = new FormData(e.currentTarget)
      const current = String(fd.get('current') || '')
      const next = String(fd.get('new') || '')
      if (next.length < 8) return toast('Password must be at least 8 characters', 'warn')

      // Optional: verify current via reauth flow (Supabase OTP/email-link). Here we directly update:
      const { error } = await q.setPassword(next)
      if (error) return toast(error.message, 'error')
      toast('Password updated', 'success')
      e.currentTarget.reset()
    })

    // Preferences (persist via UPDATE)
    $('pref-language')?.addEventListener('change', async (e) => {
      await q.updateProfile(currentUser.id, { language: e.target.value })
      toast('Language saved', 'success')
    })
    $('pref-theme')?.addEventListener('change', async (e) => {
      const theme = e.target.value
      localStorage.setItem('theme', theme)
      applyDark(theme)
      await q.updateProfile(currentUser.id, { theme })
      toast('Theme saved', 'success')
    })
    $('pref-currency')?.addEventListener('change', async (e) => {
      await q.updateProfile(currentUser.id, { currency: e.target.value })
      toast('Currency saved', 'success')
    })

    // Transactions filters
    $('txTypeFilter')?.addEventListener('change', filterTx)
    $('txFrom')?.addEventListener('change', filterTx)
    $('txTo')?.addEventListener('change', filterTx)

    async function filterTx() {
      const type = $('txTypeFilter').value
      const from = $('txFrom').value ? new Date($('txFrom').value).toISOString() : null
      const to   = $('txTo').value ? new Date($('txTo').value).toISOString() : null
      const { data, error } = await q.transactions(currentUser.id, { type, from, to })
      if (error) return toast(error.message, 'error')
      renderTransactionsTable(data || [])
    }

    // Portfolio perf range (demo transform; real impl: query by range)
    $('perfRange')?.addEventListener('change', (e) => {
      const days = Number(e.target.value || 7)
      const base = 100
      const labels = Array.from({ length: days }, (_, i) => `D${i+1}`)
      const values = labels.map((_, i) => base + Math.sin(i/2) * 3 + i*0.4)
      if (!state.portfolio) state.portfolio = {}
      state.portfolio.perf = { labels, values }
      renderPortfolioCharts()
    })

    // Holdings filters
    $('assetSearch')?.addEventListener('input', debounce(async (e) => {
      const search = e.target.value
      const klass = $('assetFilter').value
      const { data, error } = await q.holdings(currentUser.id, { search, class: klass })
      if (error) return toast(error.message, 'error')
      state.holdings = data || []
      renderHoldings(); renderKPIs()
    }, 250))
    $('assetFilter')?.addEventListener('change', async (e) => {
      const klass = e.target.value
      const search = $('assetSearch').value
      const { data, error } = await q.holdings(currentUser.id, { search, class: klass })
      if (error) return toast(error.message, 'error')
      state.holdings = data || []
      renderHoldings(); renderKPIs()
    })

    // Threads / messages
    $('btn-new-thread')?.addEventListener('click', async () => {
      const subj = prompt('Subject for new conversation:')
      if (!subj) return
      const payload = { user_id: currentUser.id, subject: subj, last_ts: new Date().toISOString() }
      const { data, error } = await q.addThread(payload)
      if (error) return toast(error.message, 'error')
      state.threads.unshift(data)
      state.activeThreadId = data.id
      renderThreads()
      await loadMessages(data.id)
    })
    $('form-message')?.addEventListener('submit', async (e) => {
      e.preventDefault()
      const text = $('msgText').value.trim()
      if (!text) return
      if (!state.activeThreadId) return toast('Select or create a thread', 'warn')
      const payload = { thread_id: state.activeThreadId, user_id: currentUser.id, ts: new Date().toISOString(), text, from_admin: false }
      const { data, error } = await q.addMessage(payload)
      if (error) return toast(error.message, 'error')
      $('msgText').value = ''
      await loadMessages(state.activeThreadId)
    })

    // Alerts
    $('btn-clear-alerts')?.addEventListener('click', async () => {
      const { error } = await q.clearAlerts(currentUser.id)
      if (error) return toast(error.message, 'error')
      state.alerts = []
      renderAlerts()
      toast('Alerts cleared', 'success')
    })
  }

  // ==== 10) UTILS ====
  function debounce(fn, ms) {
    let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), ms) }
  }

  // ==== 11) INIT ====
  document.addEventListener('DOMContentLoaded', async () => {
    try {
      // Icons
      if (window.lucide) window.lucide.createIcons()

      initDark()
      initRouter()

      currentUser = await ensureSession()
      if (!currentUser) return

      await bootstrap()
      initEvents()

      // Optional: badge demo for notifications count
      const badge = $('badge'); if (badge) { badge.textContent = String((state.alerts || []).length); badge.classList.toggle('hidden', (state.alerts || []).length === 0) }

      toast('Dashboard ready', 'success')
    } catch (err) {
      console.error(err)
      toast('Failed to initialize dashboard', 'error')
    }
  })
})()
</script>

  </body>

</html>
